{% extends "base.html" %}

{% block title %}Chat - AI Defense System{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">AI Defense Chat Assistant</h5>
                </div>
                <div class="card-body">
                    <div class="chat-container" id="chatContainer">
                        <!-- Messages will be dynamically added here -->
                    </div>
                    <div class="chat-input mt-3">
                        <form id="chatForm" class="d-flex">
                            <input type="text" id="messageInput" class="form-control me-2" placeholder="Type your message...">
                            <button type="submit" class="btn btn-primary">Send</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.chat-container {
    height: 400px;
    overflow-y: auto;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 0.25rem;
}

.message {
    margin-bottom: 1rem;
    padding: 0.75rem;
    border-radius: 0.5rem;
    max-width: 80%;
}

.user-message {
    background: #007bff;
    color: white;
    margin-left: auto;
}

.ai-message {
    background: #e9ecef;
    color: #212529;
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.8;
    margin-top: 0.25rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatContainer = document.getElementById('chatContainer');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');

    // Load existing messages
    loadMessages();

    // Handle form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
            sendMessage(message);
            messageInput.value = '';
        }
    });

    function loadMessages() {
        fetch('/api/chat/messages')
            .then(response => response.json())
            .then(messages => {
                messages.reverse().forEach(message => {
                    appendMessage(message);
                });
                scrollToBottom();
            })
            .catch(error => console.error('Error loading messages:', error));
    }

    function sendMessage(message) {
        fetch('/api/chat/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            appendMessage(data.user_message);
            appendMessage(data.ai_response);
            scrollToBottom();
        })
        .catch(error => console.error('Error sending message:', error));
    }

    function appendMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${message.is_ai_response ? 'ai-message' : 'user-message'}`;
        
        const messageContent = document.createElement('div');
        messageContent.textContent = message.message;
        
        const messageTime = document.createElement('div');
        messageTime.className = 'message-time';
        messageTime.textContent = new Date(message.timestamp).toLocaleString();
        
        messageDiv.appendChild(messageContent);
        messageDiv.appendChild(messageTime);
        chatContainer.appendChild(messageDiv);
    }

    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
});
</script>
{% endblock %}
