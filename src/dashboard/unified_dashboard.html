<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Defence System - Unified Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .chart-container {
            height: 300px;
            margin-bottom: 1rem;
        }
        .metric-card {
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }
        .status-good { background-color: #10B981; }
        .status-warning { background-color: #F59E0B; }
        .status-critical { background-color: #EF4444; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <!-- Navigation -->
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between h-16">
                    <div class="flex">
                        <div class="flex-shrink-0 flex items-center">
                            <h1 class="text-2xl font-bold text-gray-800">AI Defence System</h1>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span id="systemStatus" class="flex items-center">
                            <span class="status-indicator status-good"></span>
                            <span class="text-sm font-medium">System Healthy</span>
                        </span>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- System Overview -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white rounded-lg shadow p-6 metric-card">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">System Load</h3>
                    <p id="systemLoad" class="text-3xl font-bold text-blue-600">0%</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6 metric-card">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Active Threats</h3>
                    <p id="activeThreats" class="text-3xl font-bold text-red-600">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6 metric-card">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">System Health</h3>
                    <p id="systemHealth" class="text-3xl font-bold text-green-600">100%</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6 metric-card">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Active Tasks</h3>
                    <p id="activeTasks" class="text-3xl font-bold text-purple-600">0</p>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-8">
                <!-- Resource Usage -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Resource Usage</h2>
                    <div id="resourceChart" class="chart-container"></div>
                </div>

                <!-- Threat Distribution -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Threat Distribution</h2>
                    <div id="threatChart" class="chart-container"></div>
                </div>

                <!-- Network Activity -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Network Activity</h2>
                    <div id="networkChart" class="chart-container"></div>
                </div>

                <!-- Performance Metrics -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Performance Metrics</h2>
                    <div id="performanceChart" class="chart-container"></div>
                </div>
            </div>

            <!-- Active Alerts -->
            <div class="bg-white rounded-lg shadow mb-8">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Active Alerts</h2>
                        <button id="acknowledgeAllBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                            Acknowledge All
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Severity
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Type
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Message
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Time
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="alertsList" class="bg-white divide-y divide-gray-200">
                                <!-- Alerts will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Threat Analysis -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <!-- Malware Analysis -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Malware Analysis</h3>
                    <div id="malwareStats"></div>
                </div>

                <!-- Deepfake Detection -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Deepfake Detection</h3>
                    <div id="deepfakeStats"></div>
                </div>

                <!-- Phishing Protection -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Phishing Protection</h3>
                    <div id="phishingStats"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Initialize Socket.IO with the new port
        const socket = io('http://127.0.0.1:5000');
        
        // Initialize data structures
        let metricsHistory = {
            timestamps: [],
            cpu: [],
            memory: [],
            network: []
        };

        let threatHistory = {
            timestamps: [],
            malware: [],
            deepfake: [],
            phishing: []
        };

        // Initialize charts
        function initializeCharts() {
            // Resource Usage Chart
            Plotly.newPlot('resourceChart', [
                {
                    name: 'CPU',
                    x: metricsHistory.timestamps,
                    y: metricsHistory.cpu,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#3B82F6' }
                },
                {
                    name: 'Memory',
                    x: metricsHistory.timestamps,
                    y: metricsHistory.memory,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#10B981' }
                }
            ], {
                title: 'Resource Usage Over Time',
                height: 300,
                margin: { t: 30, l: 60, r: 30, b: 40 }
            });

            // Threat Distribution Chart
            Plotly.newPlot('threatChart', [
                {
                    name: 'Malware',
                    x: threatHistory.timestamps,
                    y: threatHistory.malware,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#EF4444' }
                },
                {
                    name: 'Deepfake',
                    x: threatHistory.timestamps,
                    y: threatHistory.deepfake,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#F59E0B' }
                },
                {
                    name: 'Phishing',
                    x: threatHistory.timestamps,
                    y: threatHistory.phishing,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#8B5CF6' }
                }
            ], {
                title: 'Threat Distribution Over Time',
                height: 300,
                margin: { t: 30, l: 60, r: 30, b: 40 }
            });

            // Network Activity Chart
            Plotly.newPlot('networkChart', [
                {
                    name: 'Incoming',
                    x: metricsHistory.timestamps,
                    y: metricsHistory.network,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#3B82F6' }
                }
            ], {
                title: 'Network Activity Over Time',
                height: 300,
                margin: { t: 30, l: 60, r: 30, b: 40 }
            });

            // Performance Metrics Chart
            Plotly.newPlot('performanceChart', [
                {
                    type: 'indicator',
                    mode: 'gauge+number',
                    value: 0,
                    title: { text: 'System Performance' },
                    gauge: {
                        axis: { range: [null, 100] },
                        bar: { color: '#3B82F6' },
                        steps: [
                            { range: [0, 50], color: '#EF4444' },
                            { range: [50, 80], color: '#F59E0B' },
                            { range: [80, 100], color: '#10B981' }
                        ]
                    }
                }
            ], {
                height: 300,
                margin: { t: 30, l: 30, r: 30, b: 30 }
            });
        }

        // Update functions
        function updateMetrics(data) {
            document.getElementById('systemLoad').textContent = `${data.cpu_usage.toFixed(1)}%`;
            document.getElementById('systemHealth').textContent = `${(100 - data.error_count).toFixed(1)}%`;
            document.getElementById('activeTasks').textContent = data.active_tasks;

            const now = new Date();
            metricsHistory.timestamps.push(now);
            metricsHistory.cpu.push(data.cpu_usage);
            metricsHistory.memory.push(data.memory_usage);
            metricsHistory.network.push(data.network_io.bytes_recv);

            if (metricsHistory.timestamps.length > 60) {
                metricsHistory.timestamps.shift();
                metricsHistory.cpu.shift();
                metricsHistory.memory.shift();
                metricsHistory.network.shift();
            }

            Plotly.update('resourceChart', {
                x: [[...metricsHistory.timestamps], [...metricsHistory.timestamps]],
                y: [metricsHistory.cpu, metricsHistory.memory]
            });

            Plotly.update('networkChart', {
                x: [[...metricsHistory.timestamps]],
                y: [metricsHistory.network]
            });

            Plotly.update('performanceChart', {
                value: 100 - data.cpu_usage
            });
        }

        function updateThreats(data) {
            document.getElementById('activeThreats').textContent = data.total;

            const now = new Date();
            threatHistory.timestamps.push(now);
            threatHistory.malware.push(data.malware);
            threatHistory.deepfake.push(data.deepfake);
            threatHistory.phishing.push(data.phishing);

            if (threatHistory.timestamps.length > 60) {
                threatHistory.timestamps.shift();
                threatHistory.malware.shift();
                threatHistory.deepfake.shift();
                threatHistory.phishing.shift();
            }

            Plotly.update('threatChart', {
                x: [[...threatHistory.timestamps], [...threatHistory.timestamps], [...threatHistory.timestamps]],
                y: [threatHistory.malware, threatHistory.deepfake, threatHistory.phishing]
            });

            // Update threat analysis cards
            document.getElementById('malwareStats').innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Detected</span>
                    <span class="font-bold">${data.malware}</span>
                </div>
            `;

            document.getElementById('deepfakeStats').innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Detected</span>
                    <span class="font-bold">${data.deepfake}</span>
                </div>
            `;

            document.getElementById('phishingStats').innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Detected</span>
                    <span class="font-bold">${data.phishing}</span>
                </div>
            `;
        }

        function updateAlerts(alerts) {
            const tbody = document.getElementById('alertsList');
            tbody.innerHTML = '';

            alerts.forEach(alert => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                            ${alert.severity === 'critical' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${alert.severity}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${alert.type}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${alert.message}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(alert.timestamp).toLocaleString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="acknowledgeAlert('${alert.id}')"
                            class="text-indigo-600 hover:text-indigo-900">
                            Acknowledge
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Event handlers
        function acknowledgeAlert(alertId) {
            socket.emit('acknowledge_alert', alertId);
        }

        document.getElementById('acknowledgeAllBtn').addEventListener('click', () => {
            socket.emit('acknowledge_all_alerts');
        });

        // Socket.IO event handlers
        socket.on('connect', () => {
            console.log('Connected to server');
            initializeCharts();
        });

        socket.on('metrics_update', (data) => {
            updateMetrics(data);
        });

        socket.on('threats_update', (data) => {
            updateThreats(data);
        });

        socket.on('alerts_update', (data) => {
            updateAlerts(data);
        });

        // Initialize dashboard
        initializeCharts();
    </script>
</body>
</html>
